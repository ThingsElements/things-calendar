<link rel="import" href="../polymer/polymer.html">
<link rel='stylesheet' href='../fullcalendar/dist/fullcalendar.min.css'/>
<link rel="import" href="../fullcalendar-calendar/fullcalendar-theme.html">
<link rel="import" href="../fullcalendar-calendar/fullcalendar-calendar.html">
<link rel="import" href="../things-ajax/things-ajax.html">
<!-- 꼭 fullcalendar-calendar 뒤에 임포트 한다.-->
<script src="../fullcalendar/dist/locale-all.js"></script>

<!--
  캘린더 
-->

<dom-module id="things-calendar">
  <template>
    <content id="headerView" select=".header"></content>

    <things-ajax id="schedule"
                 query-fields ="[[queryFields]]"
                 resource-url="[[scheduleUrl]]"
                 resource-action="index"
                 on-things-ajax-response="_handleScheduleResponse"
                 auto>
    </things-ajax>
    
    <fullcalendar-calendar
      id ="calendar"
      options="[[options]]"
      on-event-click="_handleEventClick"
      on-day-click="_notifyDayClick">
    </fullcalendar-calendar>
  </template>

  <script>
    Polymer({

      properties: {
        /**
         * view options
         * please refer https://fullcalendar.io/docs/
         * @type {Object}
         */
        options: {
          type: Object,
          value: {}
        },

        /**
         * for event title field of response after schedule url called and ajax returned
         * @type {String}
         */
        eventTitleField: {
          type: String,
          value: 'name'
        },
        
        /**
         * for event start datetime field of response after schedule url called and ajax returned
         * @type {String}
         */
        eventTimeField: {
          type: String,
          value: 'plan_date'
        },

        /**
         * for event start datetime format field of response after schedule url called and ajax returned
         * @type {String}
         */
        eventTimeFormat:{
          type: String,
          value: 'YYYY-MM-DD'
        },
        /**
         * condition for schedule url calling
         * @type {Object}
         */
        eventQueryFields: {
          type: Object
        },
        
        /**
         * condition for schedule url calling that add starttime and endtime
         * @type {Array}
         */
        queryFields: {
          type: Array,
          computed: '_onEventQueryFieldChange(eventQueryFields)'
        },

        /**
         * url for get resource data
         * @type {String}
         */
        scheduleUrl: {
          type: String,
          value: 'machine_checks'
        },

        /**
         * for render background color
         * @type {function}
         */
        eventBackgroundColorRender: {
          type: Object,
          value: function() {
            return function(event, calendar) { return event };
          }
        },

        /**
         * for render font color
         * @type {function}
         */
        eventFontColorRender: {
          type: Object,
          value: function() {
            return function(event, calendar) { return event };
          }
        },

        /**
         * for render border color
         * @type {function}
         */
        eventBorderColorRender: {
          type: Object,
          value: function() {
            return function(event, calendar) { return event };
          }
        },

        /**
         * when locale changed view must be changed
         * @type {String}
         */
        locale: {
          type: String,
          observer: '_onLocaleChange'
        }
      },

      _onLocaleChange: function(locale) {
        this.$.calendar._calendar.fullCalendar('option', 'locale', locale);
      },

      _onEventQueryFieldChange: function(eventQueryFields) {
        if(eventQueryFields){
          eventQueryFields = (typeof(eventQueryFields) == 'string') ? JSON.parse(eventQueryFields): eventQueryFields;
        }else{
          eventQueryFields =[];
        }
        eventQueryFields.push({name: this.eventTimeField, operator: 'gte', value: this._calendarStartDayOfMonth()});
        eventQueryFields.push({name: this.eventTimeField, operator: 'lte', value: this._calendarEndDayOfMonth()});

        eventQueryFields = JSON.stringify(eventQueryFields);
        return eventQueryFields
      },
      _calendarStartDayOfMonth: function(){
        var firstDayOfMonth = moment().startOf('month');
        var weekOfFirstday = firstDayOfMonth.day();
        return firstDayOfMonth.add(-weekOfFirstday,'day').format(this.eventTimeFormat);

      },
      _calendarEndDayOfMonth: function(){
        var lastDayOfMonth = moment().endOf('month');
        var weekOfLastday = lastDayOfMonth.day();
        return lastDayOfMonth.add(6-weekOfLastday,'day').format(this.eventTimeFormat);
      },
      // change view use value of target element with named 'view' attribute
      changeView: function(event) {
        var calendar = this.$.calendar;
        calendar.changeView(event.target.attributes.getNamedItem('view').value);
      },

      // show previous month, week, day
      previous: function() {
        this.$.calendar.previous();
      },
      
      // show next month, week, day
      next: function() {
        this.$.calendar.next();
      },
      
      getSchedule: function(event) {
        this.$['schedule'].generateRequest();
      },
      
      _handleScheduleResponse: function(event) {
        var schedule = event.detail.items;
        if(schedule){
          var eventDetail = { thingsCalendar: this, calendar: this.$.calendar, event: schedule };
          var evt = this.fire('things-calendar-event-response', eventDetail, { cancelable: true });

          if (!evt.defaultPrevented) {
            var self = this;
            this.events = schedule.map(function(object) {
              return {
                title : object[self.eventTitleField],
                start : moment(object[self.eventTimeField]),
                borderColor : '#ffffff',
                allDay : true,
                schedule : object,
                backgroundColor : self.eventBackgroundColorRender(object, self.$.calendar),
                textColor : self.eventFontColorRender(object, self.$.calendar),
                borderColor : self.eventBorderColorRender(object, self.$.calendar)
              };
            });

            var headerView = {
              right: 'prev,next today',
              center: 'title',
              left: 'month,agendaWeek,agendaDay,listWeek'
            }

            var options = {
              header: headerView,
              weekends: true,
              locale: this.locale,
              events: this.events
            };

            this.set('options', options);
          }
        }
      },

      _notifyDayClick : function(event) {
        this.fire('things-day-tap', event.detail);
      },

      _handleEventClick: function(event) {
        this.fire('things-event-tap', event.detail.event);
      }
    });
  </script>
</dom-module>
